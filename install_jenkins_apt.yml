- hosts: all
  become: true

  tasks:
    - name: install python3 pip, setuptools and python3-boto3
      apt: 
        name: "{{item}}"
        state: present
        update_cache: true
      loop: 
        - python3-pip
        - python3-setuptools
        - openjdk-17-jre
        # - python3-boto3
        # - build-essential

    - name: install fontconfig
      apt: name=fontconfig update_cache=true state=present

    - name: fix python and pip
      apt: name=python-is-python3 update_cache=true state=present

    - name: create python pip alias
      shell: echo alias pip=pip3 >> ~/.bashrc

    - name: upgrade pip with packages
      pip: 
        name: "{{item}}"
        state: latest
      loop: 
        - pip
        - bottle
        - botocore
      # - firewall

    - name: ensure the jenkins apt repository key is installed
      apt_key: url=https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key state=present

    - name: ensure the repository is configured
      apt_repository: repo='deb https://pkg.jenkins.io/debian-stable binary/' state=present update_cache_retries=3

    - name: ensure jenkins is installed
      apt: name=jenkins update_cache=true

    - name: ensure jenkins is running
      service: name=jenkins state=started enabled=true
      register: jenkinsrunning

    - name: ensure ufw is running
      service: name=ufw state=started enabled=true

    - name: allow all ssh connection
      ufw:
        rule: allow
        port: ssh
        proto: tcp

    - name: add port 80 and dest 8080
      ufw:
        rule: allow
        proto: any
        port: 80
        # to_port: 8080
        log: yes

    - name: add port 443 and dest 8443
      ufw:
        rule: limit
        proto: any
        from_port: 443
        to_port: 8443
        log: yes    

    - name: notify slack - successfully installed jenkins
      community.general.slack:
        token: T05Q37QNH97/B05Q4056Y6M/q76qaZoerJCLg00q8MqlK7qD
        msg: |
            ### StatusUpdate ###
            – ------------------------------------
            ``
            `Server`: {{ansible_host}}
            `Status`: Ansible Jenkins Install Job Successful
            – ------------------------------------
        channel: '#automation-deployments'
        color: good
      delay: 30
      when: jenkinsrunning is not failed
      ignore_errors: true

    - name: notify slack - unsuccessful deployment
      community.general.slack:
        token: T05Q37QNH97/B05Q4056Y6M/q76qaZoerJCLg00q8MqlK7qD
        msg: |
            ### StatusUpdate ###
            – ------------------------------------
            ``
            `Server`: {{ansible_host}}
            `Status`: Ansible Jenkins Install Job NOT successful
            – ------------------------------------
        channel: '#automation-deployments'
        color: good
      delay: 30
      when: jenkinsrunning is failed
      ignore_errors: true

